#!/usr/bin/env sh
# Skip in CI environment
[ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ] && exit 0

# Get repo root directory
ROOT=$(git rev-parse --show-toplevel)

# Detect package manager from package.json or lockfiles
detect_pm() {
  # Check packageManager field in package.json (e.g., "pnpm@9.0.0")
  if [ -f "$ROOT/package.json" ]; then
    pm=$(jq -r '.packageManager // empty' "$ROOT/package.json" 2>/dev/null | cut -d'@' -f1)
    if [ -n "$pm" ]; then
      echo "$pm"
      return
    fi
  fi

  # Fallback to lockfile detection
  if [ -f "$ROOT/pnpm-lock.yaml" ]; then
    echo "pnpm"
  elif [ -f "$ROOT/yarn.lock" ]; then
    echo "yarn"
  elif [ -f "$ROOT/bun.lock" ]; then
    echo "bun"
  else
    echo "npm"
  fi
}

# Get the dlx/npx equivalent command for the detected package manager
PM=$(detect_pm)
case "$PM" in
  pnpm) CMD="pnpm dlx" ;;
  yarn) CMD="yarn dlx" ;;
  bun)  CMD="bun x" ;;
  *)    CMD="npx --no --" ;;
esac

$CMD commitlint --config "$ROOT/lib/configs/commitlint.config.ts" --edit "$1"
